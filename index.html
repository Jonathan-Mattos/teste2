<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado Dinâmico - Banco de Dados</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-green: #36a832;
            --external-bg: #17319b; 
            --white: #ffffff;
            --text-main: #2d3436;
            --correct-green: #27ae60;
            --wrong-red: #d63031;
            --timer-red: #e62222;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--external-bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--white);
            max-width: 800px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            position: relative;
            min-height: 400px;
        }

        .header-title { color: white; text-align: center; margin-bottom: 25px; text-transform: uppercase; }

        .timer-box {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            color: var(--timer-red);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .progress-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-green); width: 0%; transition: width 0.3s ease; }

        .question-text { font-size: 1.2rem; color: var(--text-main); margin-bottom: 25px; font-weight: 600; line-height: 1.4; }

        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .option-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .option-card:hover { border-color: var(--primary-green); background: #f0fff0; }
        .option-card.selected { background: var(--primary-green); color: white; border-color: var(--primary-green); }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 25px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-next { background: var(--primary-green); color: white; }
        .btn-prev { background: #636e72; color: white; }

        #result-screen { display: none; text-align: center; }
        .review-item { text-align: left; background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .explanation-box { background: #e8f5e9; padding: 10px; border-left: 4px solid var(--primary-green); margin-top: 10px; font-style: italic; }
        
        /* Loading spinner */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-green); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h1 class="header-title">Simulado SAEP - Gestão de Dados</h1>

    <div class="container">
        <div id="loading"><div class="loader"></div><p style="text-align:center">Carregando questões da planilha...</p></div>

        <div id="quiz-content" style="display:none;">
            <div class="timer-box">⏳ <span id="timer">02:00:00</span></div>
            <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
            <div id="questionNumber" style="font-weight: bold; color: #666; margin-bottom: 10px;"></div>
            <div class="question-text" id="questionText"></div>
            <div class="options-grid" id="optionsGrid"></div>

            <div class="nav-buttons">
                <button class="btn-prev" onclick="prevQuestion()" id="prevBtn">Anterior</button>
                <button class="btn-next" onclick="nextQuestion()" id="nextBtn">Próxima</button>
                <button class="btn-next" onclick="finishQuiz()" id="finishBtn" style="display:none; background: #2d3436;">Finalizar Simulado</button>
            </div>
        </div>

        <div id="result-screen">
            <h2>Resultado do Simulado</h2>
            <canvas id="scoreChart" style="max-width: 250px; margin: 0 auto;"></canvas>
            <h3 id="finalScore" style="margin-top:20px;"></h3>
            <div id="performanceMessage" style="font-size: 1.1rem; margin-bottom: 20px;"></div>
            <button class="btn-next" onclick="location.reload()">Refazer Simulado</button>
            <div id="reviewArea" style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;"></div>
        </div>
    </div>

    <script>
        // === CONFIGURAÇÃO: COLE O LINK DO SEU CSV PUBLICADO ABAIXO ===
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT9XNps8c6jUHWhOzqpRnTD-rkdMI9Y-ZE11sk-OQrGmUtOOhjBFxuAT-z2zduB47CXd7tvn3DcmJyJ/pub?output=csv"; 

        let questions = [];
        let currentQuestion = 0;
        let selectedAnswers = [];
        let timeLeft = 7200; // 2 horas
        let timerInterval;

        async function fetchQuestions() {
            try {
                const response = await fetch(sheetUrl);
                const csvData = await response.text();
                
                // Parse CSV simples (lidando com aspas)
                const rows = csvData.split(/\r?\n/).slice(1); 
                questions = rows.map(row => {
                    const parts = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if (!parts || parts.length < 7) return null;
                    return {
                        q: parts[0].replace(/"/g, ""),
                        options: [parts[1], parts[2], parts[3], parts[4]].map(o => o.replace(/"/g, "")),
                        correct: parseInt(parts[5].replace(/"/g, "")),
                        exp: parts[6].replace(/"/g, "")
                    };
                }).filter(q => q !== null);

                selectedAnswers = new Array(questions.length).fill(null);
                document.getElementById("loading").style.display = "none";
                document.getElementById("quiz-content").style.display = "block";
                
                startTimer();
                loadQuestion();
            } catch (error) {
                document.getElementById("loading").innerHTML = "<h3>Erro ao conectar com a planilha.</h3><p>Verifique se o link está correto e se a planilha foi 'Publicada na Web'.</p>";
            }
        }

        function startTimer() { timerInterval = setInterval(updateTimer, 1000); }

        function updateTimer() {
            const h = Math.floor(timeLeft / 3600);
            const m = Math.floor((timeLeft % 3600) / 60);
            const s = timeLeft % 60;
            document.getElementById("timer").innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if (timeLeft <= 0) { clearInterval(timerInterval); finishQuiz(); }
            else timeLeft--;
        }

        function loadQuestion() {
            const q = questions[currentQuestion];
            document.getElementById("questionNumber").innerText = `Questão ${currentQuestion + 1} de ${questions.length}`;
            document.getElementById("questionText").innerText = q.q;
            
            const grid = document.getElementById("optionsGrid");
            grid.innerHTML = "";
            q.options.forEach((opt, i) => {
                const card = document.createElement("div");
                card.className = `option-card ${selectedAnswers[currentQuestion] === i ? 'selected' : ''}`;
                card.innerText = `${String.fromCharCode(65 + i)}) ${opt}`;
                card.onclick = () => { selectedAnswers[currentQuestion] = i; loadQuestion(); };
                grid.appendChild(card);
            });

            document.getElementById("progressBar").style.width = `${((currentQuestion + 1) / questions.length) * 100}%`;
            document.getElementById("prevBtn").style.visibility = currentQuestion === 0 ? "hidden" : "visible";
            document.getElementById("nextBtn").style.display = currentQuestion === questions.length - 1 ? "none" : "block";
            document.getElementById("finishBtn").style.display = currentQuestion === questions.length - 1 ? "block" : "none";
        }

        function nextQuestion() { currentQuestion++; loadQuestion(); }
        function prevQuestion() { currentQuestion--; loadQuestion(); }

        function finishQuiz() {
            clearInterval(timerInterval);
            let score = 0;
            let reviewHtml = "";
            const total = questions.length;
            const passScore = Math.ceil(total * 0.8); // 80%

            questions.forEach((q, i) => {
                if (selectedAnswers[i] === q.correct) score++;
                else {
                    reviewHtml += `<div class='review-item'>
                        <strong>${i+1}.</strong> ${q.q}<br>
                        <span style="color:var(--wrong-red)">Sua: ${selectedAnswers[i] !== null ? q.options[selectedAnswers[i]] : 'Nula'}</span> | 
                        <span style="color:var(--correct-green)">Correta: ${q.options[q.correct]}</span>
                        <div class="explanation-box"><b>Justificativa:</b> ${q.exp}</div></div>`;
                }
            });

            document.getElementById("quiz-content").style.display = "none";
            document.getElementById("result-screen").style.display = "block";
            document.getElementById("finalScore").innerText = `Pontuação: ${score} de ${total} (${(score/total*100).toFixed(1)}%)`;
            
            const msg = document.getElementById("performanceMessage");
            msg.innerHTML = score >= passScore ? `<b style="color:green">APROVADO!</b>` : `<b style="color:red">REPROVADO. Necessário 80% (${passScore} acertos).</b>`;

            new Chart(document.getElementById('scoreChart'), {
                type: 'pie',
                data: {
                    labels: ['Acertos', 'Erros'],
                    datasets: [{ data: [score, total - score], backgroundColor: ['#27ae60', '#d63031'] }]
                }
            });
            document.getElementById("reviewArea").innerHTML = "<h3>Revisão das Questões:</h3>" + (reviewHtml || "Gabaritou!");
        }

        fetchQuestions();
    </script>
</body>
</html>